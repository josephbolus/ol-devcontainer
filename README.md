# MySQL Devcontainer Sandbox

This repo provisions a VS Code devcontainer with a MySQL primary/replica pair and a utility
workspace container (`devcontainer`). SSH access is baked into the DB containers so you can
shell in, copy files, or mount them via SFTP/SSHFS from inside the workspace container.

## Containers

- `devcontainer`: Ubuntu 22.04 with MySQL Shell, client tools, and the SSH client. VS Code
  attaches here (`remoteUser` = `vscode`).
- `mysql-primary` and `mysql-replica`: Rocky Linux 9 images built from `.devcontainer/mysql
  /Dockerfile.mysql`. Each runs `mysqld` and `sshd` under supervisord with data persisted at
  `/data/mysql`.

## SSH usage from the workspace container

After the devcontainer starts (or after running
`.devcontainer/scripts/setup-ssh-client.sh`) you can:

```bash
ssh mysql-primary
ssh mysql-replica

scp ./some-file.sql mysql-primary:/tmp/
scp mysql-replica:/var/log/mysqld.log ./logs/

printf 'ls\n' | sftp mysql-primary
```

Aliases `mysql-primary` and `mysql-replica` come from `.devcontainer/ssh/config` and use the
ED25519 key stored at `~/.ssh/devcontainer-mysql-ed25519` inside `devcontainer`.
The same key is installed in the MySQL containers for the non-root `dev` user.

SSH sessions land in the `dev` account (NOPASSWD sudo, member of the `mysql` group). Examples:

```bash
docker exec -it mysql-primary supervisorctl status
sudo supervisorctl restart mysqld

sudo ls /data/mysql
sudo tail -f /var/log/mysqld.log
```

## Rotating SSH keys

The key pair under `.devcontainer/ssh/` is generated by the post-create hook and ignored by Git.
To rotate it:

1. Delete the files in `.devcontainer/ssh/` (or replace them with your own).
2. Re-run `.devcontainer/scripts/setup-ssh-client.sh` inside `devcontainer`.
3. Restart the MySQL containers: `docker compose -f .devcontainer/docker-compose.yml restart
   mysql-primary mysql-replica`.

The helper `cleanup.sh` (run from the host, not inside the devcontainer) can tear everything down
and remove volumes/networks when you need a clean restart.

This sequence regenerates the ED25519 key pair, updates `authorized_keys`, and refreshes the
workspace SSH client configuration.

## Database automation

- `.devcontainer/mysql/setup-db.sh` seeds the primary/replica and configures replication.
- `.devcontainer/mysql/verify-replication.sh` validates status and data sync; it runs on every
  devcontainer start and should be executed manually before changes are committed.

## Automated tests

- Run `./tests/run-all.sh` from the host to execute the end-to-end smoke test. It rebuilds the
  images, exercises the SSH/supervisor workflows, checks replication, and tears everything down.

```
$ bash .devcontainer/mysql/setup-db.sh
$ bash .devcontainer/mysql/verify-replication.sh
✅ Replication OK
```

Grab the replication “OK” line for PR evidence as outlined in the repository guidelines.
